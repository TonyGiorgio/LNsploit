use std::{fmt, str::FromStr};

use lightning::util::logger::{Logger, Record};
use tui::{
    layout::{Constraint, Direction, Layout, Rect},
    text::Text,
    widgets::{Block, Borders, Paragraph, Wrap},
};

use crate::{
    application::{AppState, Toast},
    router::Action,
    widgets::{constants::white, draw::draw_selectable_list},
};

use super::ScreenFrame;

#[derive(Default)]
pub enum ExploitAction {
    BreakLNDFifteenOne,
    BreakLNDFifteenThree,
    #[default]
    Invalid,
}

impl fmt::Display for ExploitAction {
    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {
        match *self {
            ExploitAction::BreakLNDFifteenOne => write!(f, "Break LND <=0.15.1"),
            ExploitAction::BreakLNDFifteenThree => write!(f, "Break LND <=0.15.3"),
            ExploitAction::Invalid => write!(f, "Invalid"),
        }
    }
}

impl FromStr for ExploitAction {
    type Err = ();

    fn from_str(s: &str) -> Result<Self, Self::Err> {
        match s {
            "Break LND <=0.15.1" => Ok(ExploitAction::BreakLNDFifteenOne),
            "Break LND <=0.15.3" => Ok(ExploitAction::BreakLNDFifteenThree),
            _ => Ok(ExploitAction::Invalid),
        }
    }
}

pub const EXPLOIT_ACTION_MENU: [ExploitAction; 2] = [
    ExploitAction::BreakLNDFifteenOne,
    ExploitAction::BreakLNDFifteenThree,
];

pub async fn handle_enter_exploit_action(
    state: &mut AppState,
    exploit_action: ExploitAction,
) -> (Option<Action>, Option<Vec<String>>) {
    let action = match exploit_action {
        ExploitAction::BreakLNDFifteenOne => {
            // Broadcast LND tx
            match state.node_manager.lock().await.broadcast_lnd_15_exploit() {
                Ok(_) => {
                    state.toast = Some(Toast::new("Broadcast transaction!", true));
                    state.logger.clone().log(&Record::new(
                        lightning::util::logger::Level::Debug,
                        format_args!("broadcasted tx!"),
                        "dad",
                        "",
                        334,
                    ));
                }
                Err(e) => {
                    state.toast = Some(Toast::new("Failed to broadcast transaction", false));
                    state.logger.clone().log(&Record::new(
                        lightning::util::logger::Level::Debug,
                        format_args!("failure to broadcast tx: {}", e),
                        "dad",
                        "",
                        334,
                    ));
                }
            }
            None
        }
        ExploitAction::BreakLNDFifteenThree => {
            match state
                .node_manager
                .lock()
                .await
                .broadcast_lnd_max_witness_items_exploit()
            {
                Ok(_) => {
                    state.toast = Some(Toast::new("Malicious block mined!", true));
                    state.logger.clone().log(&Record::new(
                        lightning::util::logger::Level::Debug,
                        format_args!("malicious block mined!"),
                        "dad",
                        "",
                        334,
                    ));
                }
                Err(e) => {
                    state.toast = Some(Toast::new("Failed to mine malicious block", false));
                    state.logger.clone().log(&Record::new(
                        lightning::util::logger::Level::Debug,
                        format_args!("failure to to mine malicious block: {}", e),
                        "dad",
                        "",
                        334,
                    ));
                }
            }
            None
        }
        _ => return (None, None),
    };

    (action, None)
}

pub fn draw_exploits(
    frame: &mut ScreenFrame,
    chunk: Rect,
    highlight_state: (bool, bool),
    menu_index: Option<usize>,
) {
    let vertical_chunks = Layout::default()
        .direction(Direction::Vertical)
        .constraints([Constraint::Percentage(50), Constraint::Percentage(50)].as_ref())
        .split(chunk);
    let text = Text::from("May you do good and not evil

May you find forgiveness for yourself and forgive others

May you share freely, never taking more than you give

Assume nothing works, and you may be pleasantly surprised; and when it breaks, you get to keep both pieces.");

    let block = Paragraph::new(text)
        .style(white())
        .block(Block::default())
        .wrap(Wrap { trim: false })
        .block(
            Block::default()
                .title("Exploit View")
                .borders(Borders::ALL)
                .border_style(white()),
        );

    frame.render_widget(block, vertical_chunks[0]);
    draw_selectable_list(
        frame,
        vertical_chunks[1],
        "Exploits",
        &EXPLOIT_ACTION_MENU,
        highlight_state,
        menu_index,
    );
}
